services:
  traefik:
    image: traefik:latest
    command:
      - --api.insecure=true  # Enable dashboard (disable in production)
      - --entrypoints.web.address=:80  # HTTP entrypoint for ACME challenge (port 80)
      - --entrypoints.websecure.address=:443  # HTTPS entrypoint (port 443)
      - --providers.docker=true  # Enable Docker provider
      - --certificatesresolvers.le.acme.email=${TRAEFIK_EMAIL}  # ACME email
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json  # ACME storage path
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web  # Use HTTP challenge on port 80
    ports:
      - "80:80"   # HTTP (for ACME http-01 challenge)
      - "443:443"  # HTTPS (served by Traefik with Let's Encrypt certs)
      - "8080:8080"  # Traefik dashboard (secure in production)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/acme.json:/letsencrypt/acme.json
    restart: unless-stopped
    networks:
      - webnet
    environment:
      - TRAEFIK_EMAIL=${TRAEFIK_EMAIL}  # Set your email for Let's Encrypt

  web:
    build: .
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=webnet"
      - "traefik.constraint-label=traefik-public"
      - "traefik.http.routers.flask-proxy-http.entrypoints=http"
      - "traefik.http.routers.flask-proxy-http.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.flask-proxy-http.service=flask-proxy"
      - "traefik.http.routers.flask-proxy-http.middlewares=https-redirect"  # Apply redirect middleware
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"  # Define redirect scheme to HTTPS
      - "traefik.http.routers.flask-proxy.entrypoints=https"
      - "traefik.http.routers.flask-proxy.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.flask-proxy.service=flask-proxy"
      - "traefik.http.routers.flask-proxy.tls=true"
      - "traefik.http.routers.flask-proxy.tls.certresolver=le"
      - "traefik.http.services.flask-proxy.loadbalancer.server.port=5000"
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PROXY_FIX_X_FOR=${PROXY_FIX_X_FOR:-1}
      - PROXY_FIX_X_PROTO=${PROXY_FIX_X_PROTO:-1}
      - PROXY_FIX_X_HOST=${PROXY_FIX_X_HOST:-1}
    expose:
      - "5000"
    restart: unless-stopped
    networks:
      - webnet

networks:
  webnet:
    driver: bridge

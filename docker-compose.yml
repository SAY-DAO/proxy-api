version: '3'

services:
  traefik:
    image: traefik:latest
    command:
      - --api.insecure=true
      - --entrypoints.http.address=:80
      - --entrypoints.https.address=:443
      - --certificatesresolvers.myresolver.acme.email=${TRAEFIK_EMAIL}  # Traefik email for Let's Encrypt
      - --certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json  # Where Traefik stores certificates
      - --certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=http  # This ensures the HTTP challenge is used
    ports:
      - "80:80"   # HTTP (ACME challenge)
      - "443:443" # HTTPS (secure traffic)
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Allow Traefik to interact with Docker
      - ./traefik/acme.json:/letsencrypt/acme.json  # Persist certificates
    restart: unless-stopped
    networks:
      - webnet
    environment:
      - TRAEFIK_EMAIL=${TRAEFIK_EMAIL}

  web:
    build: .
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=webnet"  # Ensure this matches the Traefik network
      - "traefik.http.routers.flask-proxy-http.entrypoints=http"  # For ACME HTTP challenge on port 80
      - "traefik.http.routers.flask-proxy-http.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.flask-proxy-http.service=flask-proxy"
      - "traefik.http.routers.flask-proxy-http.middlewares=https-redirect"  # Redirect HTTP to HTTPS
      - "traefik.http.routers.flask-proxy.entrypoints=https"  # HTTPS routing
      - "traefik.http.routers.flask-proxy.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.flask-proxy.service=flask-proxy"
      - "traefik.http.routers.flask-proxy.tls=true"  # TLS enabled
      - "traefik.http.routers.flask-proxy.tls.certresolver=myresolver"  # ACME resolver
      - "traefik.http.services.flask-proxy.loadbalancer.server.port=5000"
    expose:
      - "5000"
    networks:
      - webnet
    restart: unless-stopped


networks:
  webnet:
    driver: bridge  # Use the bridge network to allow Traefik and the web service to communicate

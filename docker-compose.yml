version: '3'

services:
  traefik:
    image: traefik:latest
    command:
      - --api.insecure=true    # Enable Traefik Dashboard (use secure in production)
      - --entrypoints.http.address=:80    # HTTP entrypoint for ACME challenge
      - --entrypoints.https.address=:443  # HTTPS entrypoint
      - --providers.docker=true   # Enable Docker provider
      - --certificatesresolvers.myresolver.acme.email=${TRAEFIK_EMAIL}  # ACME email from .env
      - --certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json  # ACME certificate storage
      - --certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=http   # Use HTTP challenge for ACME
    ports:
      - "80:80"   # HTTP (for ACME challenge and HTTP traffic)
      - "443:443"  # HTTPS (secure traffic with Let's Encrypt certs)
      - "8080:8080"  # Traefik Dashboard (optional, secure in production)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Enable Traefik to interact with Docker
      - ./traefik/acme.json:/letsencrypt/acme.json   # Volume to store ACME certificates
    restart: unless-stopped
    networks:
      - webnet
    environment:
      - TRAEFIK_EMAIL=${TRAEFIK_EMAIL}  # Get the email for Let's Encrypt from .env

  web:
    build: .
    labels:
    - "traefik.enable=true"
    - "traefik.docker.network=webnet"
    - "traefik.constraint-label=traefik-public"
    
    # HTTP router for ACME challenge and general HTTP traffic (port 80)
    - "traefik.http.routers.my-service-http.entrypoints=http"  # HTTP entrypoint for ACME challenge
    - "traefik.http.routers.my-service-http.rule=Host(`${DOMAIN}`)"  # Ensure DOMAIN variable is correctly referenced
    - "traefik.http.routers.my-service-http.service=my-service"  # Associate with the web service
    - "traefik.http.routers.my-service-http.middlewares=https-redirect"  # Apply redirect middleware

    # HTTPS router for secure traffic (port 443)
    - "traefik.http.routers.my-service-https.entrypoints=https"  # HTTPS entrypoint
    - "traefik.http.routers.my-service-https.rule=Host(`${DOMAIN}`)"  # Ensure DOMAIN variable is correctly referenced
    - "traefik.http.routers.my-service-https.service=my-service"  # Associate with the web service
    - "traefik.http.routers.my-service-https.tls=true"  # Enable TLS for HTTPS
    - "traefik.http.routers.my-service-https.tls.certresolver=myresolver"  # Use ACME resolver (Let's Encrypt)

    # Service configuration (backend Flask app listening on port 5000)
    - "traefik.http.services.my-service.loadbalancer.server.port=5000"  # The Flask app listens on port 5000

    # Define the redirect middleware from HTTP to HTTPS
    - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"  # Redirect HTTP to HTTPS

    environment:
      - LOG_LEVEL=${LOG_LEVEL}  # Use the log level from .env file
    expose:
      - "5000"  # Expose the Flask app on port 5000
    restart: unless-stopped
    networks:
      - webnet

networks:
  webnet:
    driver: bridge  # Use the bridge network to allow Traefik and the web service to communicate

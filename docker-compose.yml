services:
  traefik:
    image: traefik:latest
    command:
      - --configFile=/etc/traefik/traefik.yml
    ports:
      - "80:80"     # HTTP (used for ACME http-01 challenge)
      - "443:443"   # HTTPS (served by Traefik with Let's Encrypt certs)
      - "8080:8080" # Traefik dashboard (optional; secure in production)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/acme.json:/letsencrypt/acme.json
    restart: unless-stopped
    networks:
      - webnet
    environment:
      - TRAEFIK_EMAIL=${TRAEFIK_EMAIL}

  web:
    build: .
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.flask-proxy.rule=Host(`${DOMAIN}`)"  # This rule will only match HTTPS requests
      - "traefik.http.routers.flask-proxy.entrypoints=websecure"  # Use the 'websecure' entry point for HTTPS
      - "traefik.http.routers.flask-proxy.tls=true"  # Enable TLS/SSL
      - "traefik.http.routers.flask-proxy.tls.certresolver=myresolver"  # Use the ACME resolver for SSL certificates
      - "traefik.http.services.flask-proxy.loadbalancer.server.port=5000"
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PROXY_FIX_X_FOR=${PROXY_FIX_X_FOR:-1}
      - PROXY_FIX_X_PROTO=${PROXY_FIX_X_PROTO:-1}
      - PROXY_FIX_X_HOST=${PROXY_FIX_X_HOST:-1}
    expose:
      - "5000"
    restart: unless-stopped
    networks:
      - webnet


networks:
  webnet:
    driver: bridge


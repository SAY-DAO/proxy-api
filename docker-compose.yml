services:
  traefik:
    image: traefik:latest
    command:
      - --api.insecure=true
      - --entrypoints.http.address=:80   # HTTP entrypoint for ACME challenge
      - --entrypoints.https.address=:443  # HTTPS entrypoint for secure traffic
      - --providers.docker=true           # Enable Docker provider
      - --certificatesresolvers.myresolver.acme.email=${TRAEFIK_EMAIL}  # ACME email for Let's Encrypt
      - --certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json  # ACME certificate storage
      - --certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=http   # Use HTTP challenge for ACME

    ports:
      - "80:80"   # HTTP (for ACME challenge and HTTP traffic)
      - "443:443" # HTTPS (secure traffic with Let's Encrypt certs)
      - "8080:8080"  # Traefik Dashboard (optional, secure in production)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Enable Traefik to interact with Docker
      - ./traefik/acme.json:/letsencrypt/acme.json   # Volume to store ACME certificates
    restart: unless-stopped
    networks:
      - proxy-api_webnet  # Correct network name to match your actual network
    environment:
      - TRAEFIK_EMAIL=${TRAEFIK_EMAIL}  # Set your email for Let's Encrypt
  web:
    build: .
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy-api_webnet"  # Use the correct network
      - "traefik.http.routers.my-service-http.entrypoints=http"  # HTTP entrypoint
      - "traefik.http.routers.my-service-http.rule=Host(`${DOMAIN}`)" # Ensure DOMAIN is correctly set
      - "traefik.http.routers.my-service-http.service=my-service"
      - "traefik.http.routers.my-service-http.middlewares=https-redirect@docker"  # Apply redirect to HTTPS

      # HTTPS router for secure traffic
      - "traefik.http.routers.my-service-https.entrypoints=https"
      - "traefik.http.routers.my-service-https.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.my-service-https.service=my-service"
      - "traefik.http.routers.my-service-https.tls=true"  # Enable TLS
      - "traefik.http.routers.my-service-https.tls.certresolver=myresolver"  # Use Let's Encrypt resolver

      - "traefik.http.services.my-service.loadbalancer.server.port=5000"  # Flask app running on port 5000

      # ACME challenge router
      - "traefik.http.routers.acme-challenge.rule=PathPrefix(`/well-known/acme-challenge/`)"
      - "traefik.http.routers.acme-challenge.entryPoints=http"
      - "traefik.http.services.acme-challenge.loadbalancer.server.port=80"

      # Define the https-redirect middleware in the labels
      - "traefik.http.middlewares.https-redirect.redirectScheme.scheme=https"  # Redirect HTTP to HTTPS
      - "traefik.http.middlewares.https-redirect.redirectScheme.permanent=true"  # Permanent redirection

# ACME Challenge Router (ensure it's handled separately)
  acme-challenge:
    image: traefik:latest
    command:
      - "--api.insecure=true"  # Optionally enable API for debugging (optional)
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.acme-challenge.rule=PathPrefix(`/well-known/acme-challenge/`)"  # ACME challenge path
      - "traefik.http.routers.acme-challenge.entryPoints=http"  # Listen on HTTP
      - "traefik.http.services.acme-challenge.loadbalancer.server.port=80"  # Handle the challenge on port 80
    networks:
      - proxy-api_webnet  # Same network as your other services for connectivity

networks:
  proxy-api_webnet:
    driver: bridge

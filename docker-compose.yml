services:
  traefik:
    image: traefik:latest
    command:
      - --configFile=/etc/traefik/traefik.yml
    ports:
      - "80:80"     # HTTP (used for ACME http-01 challenge)
      - "443:443"   # HTTPS (served by Traefik with Let's Encrypt certs)
      - "8080:8080" # Traefik dashboard (optional; secure in production)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/acme.json:/letsencrypt/acme.json
    restart: unless-stopped
    networks:
      - webnet
    environment:
      - TRAEFIK_EMAIL=${TRAEFIK_EMAIL}

  web:
    build: .
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.flask-proxy-http.rule=Host(`${DOMAIN}`)"  # This is correct for HTTP requests
    - "traefik.http.routers.flask-proxy-http.entrypoints=web"  # Ensure it listens on the 'web' entry point
    - "traefik.http.routers.flask-proxy-http.priority=1"
    - "traefik.http.routers.flask-proxy-http.middlewares=redirect-to-https"
    - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
    - "traefik.http.services.flask-proxy.loadbalancer.server.port=5000"
    - "traefik.http.routers.flask-proxy.rule=Host(`proxy.saydao.org`)"  # Make sure this matches the domain in the certificate
    - "traefik.http.routers.flask-proxy.entrypoints=websecure"  # This is for HTTPS, correct
    - "traefik.http.routers.flask-proxy.tls=true"
    - "traefik.http.routers.flask-proxy.tls.certresolver=myresolver"  # Ensure this matches the ACME resolver
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PROXY_FIX_X_FOR=${PROXY_FIX_X_FOR:-1}
      - PROXY_FIX_X_PROTO=${PROXY_FIX_X_PROTO:-1}
      - PROXY_FIX_X_HOST=${PROXY_FIX_X_HOST:-1}
    expose:
      - "5000"
    restart: unless-stopped
    networks:
      - webnet


networks:
  webnet:
    driver: bridge

